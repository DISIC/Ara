// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Recipent {
  id    Int    @id @default(autoincrement())
  name  String
  email String

  Audit         Audit?  @relation(fields: [auditUniqueId], references: [editUniqueId])
  auditUniqueId String?

  @@unique([email, auditUniqueId])
}

enum AuditType {
  FAST // 25 criteria
  COMPLEMENTARY // 50 criteria
  FULL // 106 criteria
}

model Audit {
  id Int @id @default(autoincrement())

  editUniqueId    String @unique
  consultUniqueId String @unique

  // Step 1

  initiator String

  procedureName String
  procedureUrl  String

  contactName    String?
  contactEmail   String
  contactFormUrl String

  recipients Recipent[]

  auditorName  String
  auditorEmail String

  // Step 2 (all fields must be optionnal)

  auditType    AuditType?
  auditTools   String[]
  environments TestEnvironment[]
  pages        AuditedPage[]
}

model TestEnvironment {
  id                  Int    @id @default(autoincrement())
  platform            String
  assistiveTechnology String
  browser             String

  audit         Audit?  @relation(fields: [auditUniqueId], references: [editUniqueId])
  auditUniqueId String?

  @@unique([platform, assistiveTechnology, browser, auditUniqueId])
}

model AuditedPage {
  id   Int    @id @default(autoincrement())
  name String
  url  String

  audit         Audit?  @relation(fields: [auditUniqueId], references: [editUniqueId])
  auditUniqueId String?

  results CriterionResult[]

  @@unique([url, auditUniqueId])
}

model CriterionResult {
  id Int @id @default(autoincrement())

  status CriterionResultStatus @default(NOT_TESTED)

  compliantComment String?

  errorDescription String?
  userImpact       CriterionResultUserImpact?
  recommandation   String?

  notApplicableComment String?

  topic     Int
  criterium Int
  pageId    Int
  page      AuditedPage @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@unique([pageId, topic, criterium])
}

enum CriterionResultStatus {
  COMPLIANT
  NOT_COMPLIANT
  NOT_APPLICABLE
  NOT_TESTED
}

enum CriterionResultUserImpact {
  MINOR
  MAJOR
  BLOCKING
}
