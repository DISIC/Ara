// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator nestjsDto {
  provider                        = "prisma-generator-nestjs-dto"
  output                          = "../src/generated/nestjs-dto"
  outputToNestJsResourceStructure = "false"
  exportRelationModifierClasses   = "true"
  reExport                        = "false"
  createDtoPrefix                 = "Create"
  updateDtoPrefix                 = "Update"
  dtoSuffix                       = "Dto"
  entityPrefix                    = ""
  entitySuffix                    = ""
  fileNamingStyle                 = "camel"
}

model Recipent {
  id    Int    @id @default(autoincrement())
  name  String
  email String

  Audit         Audit?  @relation(fields: [auditUniqueId], references: [editUniqueId], onDelete: Cascade)
  auditUniqueId String?

  @@unique([email, auditUniqueId])
}

enum AuditType {
  FAST // 25 criteria
  COMPLEMENTARY // 50 criteria
  FULL // 106 criteria
}

model Audit {
  id Int @id @default(autoincrement())

  // Audit creation step
  auditType           AuditType
  procedureName       String
  /// @DtoEntityHidden
  pages               AuditedPage[]
  auditorName         String?
  auditorEmail        String
  auditorOrganisation String

  // A11y declaration edition step
  initiator           String?
  procedureUrl        String?
  contactName         String?
  contactEmail        String?
  contactFormUrl      String?
  technologies        String[]
  tools               String[]
  environments        TestEnvironment[]
  notCompliantContent String?
  derogatedContent    String?
  notInScopeContent   String?

  // Misc
  recipients      Recipent[] // unused for now
  creationDate    DateTime?
  publicationDate DateTime?
  editionDate     DateTime?
  editUniqueId    String     @unique
  consultUniqueId String     @unique
  auditTraceId    Int        @unique
  auditTrace      AuditTrace @relation(fields: [auditTraceId], references: [id])
  
  // Audit duplication history
  sourceAudit Audit? @relation("AuditDuplicationHistory", fields: [sourceAuditId], references: [id])
  sourceAuditId Int?
  auditCopies Audit[] @relation("AuditDuplicationHistory")

  @@unique([editUniqueId, consultUniqueId])
}

model TestEnvironment {
  id                         Int     @id @default(autoincrement())
  platform                   String
  operatingSystem            String
  operatingSystemVersion     String?
  assistiveTechnology        String
  assistiveTechnologyVersion String?
  browser                    String
  browserVersion             String?

  audit         Audit?  @relation(fields: [auditUniqueId], references: [editUniqueId], onDelete: Cascade)
  auditUniqueId String?

  @@unique([platform, operatingSystem, operatingSystemVersion, assistiveTechnology, assistiveTechnologyVersion, browser, browserVersion, auditUniqueId])
}

model AuditedPage {
  id   Int    @id @default(autoincrement())
  name String
  url  String

  audit         Audit?  @relation(fields: [auditUniqueId], references: [editUniqueId], onDelete: Cascade)
  auditUniqueId String?

  results CriterionResult[]
}

model CriterionResult {
  id Int @id @default(autoincrement())

  status     CriterionResultStatus @default(NOT_TESTED)
  transverse Boolean               @default(false)

  compliantComment String?

  errorDescription String?
  userImpact       CriterionResultUserImpact?
  recommandation   String?
  exampleImages    StoredFile[]

  notApplicableComment String?

  topic     Int
  criterium Int

  // Results are linked through the page url and audit unique id.
  pageId Int
  /// @DtoEntityHidden
  page   AuditedPage @relation(fields: [pageId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@unique([pageId, topic, criterium])
}

enum CriterionResultStatus {
  COMPLIANT
  NOT_COMPLIANT
  NOT_APPLICABLE
  NOT_TESTED
}

enum CriterionResultUserImpact {
  MINOR
  MAJOR
  BLOCKING
}

model AuditTrace {
  id                   Int    @id @default(autoincrement())
  auditEditUniqueId    String @unique
  auditConsultUniqueId String @unique
  Audit                Audit?
}

model StoredFile {
  id               Int    @id @default(autoincrement())
  originalFilename String
  url              String
  size             Int

  // S3 storage key
  key String

  thumbnailUrl String
  thumbnailKey String

  criterionResult   CriterionResult? @relation(fields: [criterionResultId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  criterionResultId Int?
}

enum EmailStatus {
  SUCCESS
  FAILURE
}

enum EmailType {
  AUDIT_CREATION
  ACCOUNT_VERIFICATION
}

model EmailLog {
  id Int @id @default(autoincrement())

  to     String
  type   EmailType
  status EmailStatus

  createdAt   DateTime @default(now())
  lastAttempt DateTime @default(now())
}

model User {
  id Int @id @default(autoincrement())

  username String @unique
  password String

  isVerified      Boolean @default(false)
  verificationJti String?
}
